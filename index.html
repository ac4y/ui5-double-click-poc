<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UI5 Double-Click POC</title>

    <!-- Környezet-váltó konfiguráció betöltése -->
    <script src="config.js"></script>
</head>
<body class="sapUiBody" id="content">

<script>
    /**
     * Fő alkalmazás inicializálás
     * A config.js határozza meg a UI5 source-t (?env=cdn|local|hybrid)
     */
    window.onAppInit = function () {
        sap.ui.require([
            "sap/m/App",
            "sap/m/Page",
            "sap/m/IconTabBar",
            "sap/m/IconTabFilter",
            "sap/m/Table",
            "sap/m/Column",
            "sap/m/ColumnListItem",
            "sap/m/Input",
            "sap/m/Text",
            "sap/m/Title",
            "sap/m/Label",
            "sap/m/VBox",
            "sap/m/HBox",
            "sap/m/Button",
            "sap/m/Toolbar",
            "sap/m/ToolbarSpacer",
            "sap/m/Select",
            "sap/ui/core/Item",
            "sap/m/MessageToast",
            "sap/m/MessageStrip",
            "sap/ui/model/json/JSONModel"
        ], function (App, Page, IconTabBar, IconTabFilter, Table, Column, ColumnListItem,
                     Input, Text, Title, Label, VBox, HBox, Button, Toolbar, ToolbarSpacer,
                     Select, Item, MessageToast, MessageStrip, JSONModel) {

            var currentEnv = window.UI5Bootstrap.getEnvironment();
            var currentConfig = window.UI5Bootstrap.getConfig();

            // =============================================
            // KÖRNYEZET INFO STRIP
            // =============================================
            var oEnvStrip = new MessageStrip({
                text: "UI5 forrás: " + currentConfig.name + " — " + currentConfig.description,
                type: "Information",
                showIcon: true,
                showCloseButton: true
            });

            // =============================================
            // KÖRNYEZET-VÁLTÓ TOOLBAR
            // =============================================
            var oEnvSelect = new Select({
                selectedKey: currentEnv,
                items: Object.keys(window.UI5_CONFIGS).map(function (key) {
                    return new Item({ key: key, text: window.UI5_CONFIGS[key].name });
                }),
                change: function (oEvent) {
                    var sKey = oEvent.getParameter("selectedItem").getKey();
                    window.location.search = "?env=" + sKey;
                }
            });

            var oToolbar = new Toolbar({
                content: [
                    new Label({ text: "Környezet:" }),
                    oEnvSelect,
                    new ToolbarSpacer(),
                    new Text({
                        text: "SAPUI5 v" + sap.ui.version
                    })
                ]
            });

            // =============================================
            // TAB 1: DUPLA-KATTINTÁSOS INPUT DEMO
            // =============================================
            var clickTracking = {};
            var clickTimeout = 500;

            function handleInputPress(oEvent) {
                var oInput = oEvent.getSource();
                var sInputId = oInput.getId();

                if (!clickTracking[sInputId]) {
                    clickTracking[sInputId] = { count: 0, timeout: null };
                }

                var oTracking = clickTracking[sInputId];
                if (oTracking.timeout) {
                    clearTimeout(oTracking.timeout);
                }

                oTracking.count++;

                if (oTracking.count === 1) {
                    MessageToast.show("Első kattintás - kattints még egyszer!");
                    oInput.addStyleClass("sapUiHighlight");

                    oTracking.timeout = setTimeout(function () {
                        oTracking.count = 0;
                        oInput.removeStyleClass("sapUiHighlight");
                    }, clickTimeout);

                } else if (oTracking.count === 2) {
                    MessageToast.show("Szerkeszthető mód!");
                    oInput.setEditable(true);
                    oInput.removeStyleClass("sapUiHighlight");

                    setTimeout(function () {
                        oInput.focus();
                        var oDomRef = oInput.getDomRef("inner");
                        if (oDomRef && oDomRef.select) {
                            oDomRef.select();
                        }
                    }, 50);

                    oTracking.count = 0;
                    clearTimeout(oTracking.timeout);

                    oInput.attachBrowserEvent("blur", function () {
                        oInput.setEditable(false);
                        MessageToast.show("Mező védve");
                    });
                }
            }

            var oTableModel = new JSONModel({
                items: [
                    { name: "Első elem", value: "100", description: "Dupla kattintással szerkeszthető" },
                    { name: "Második elem", value: "200", description: "Védett adat" },
                    { name: "Harmadik elem", value: "300", description: "Próbáld ki!" },
                    { name: "Negyedik elem", value: "400", description: "500ms timeout" }
                ]
            });

            var oTable = new Table({
                headerText: "Védett adatok - Kattints kétszer az Érték mezőre!",
                columns: [
                    new Column({ header: new Text({ text: "Név" }), width: "25%" }),
                    new Column({ header: new Text({ text: "Érték (2x katt)" }), width: "25%" }),
                    new Column({ header: new Text({ text: "Leírás" }), width: "50%" })
                ]
            });

            oTable.setModel(oTableModel);
            oTable.bindItems({
                path: "/items",
                template: new ColumnListItem({
                    cells: [
                        new Text({ text: "{name}" }),
                        new Input({
                            value: "{value}",
                            editable: false,
                            width: "100%",
                            press: handleInputPress
                        }),
                        new Text({ text: "{description}" })
                    ]
                })
            });

            var oDoubleClickTab = new VBox({
                class: "sapUiSmallMargin",
                items: [
                    new Title({ text: "Használat:", level: "H3" }),
                    new Text({
                        text: "1. Kattints EGYSZER -> Highlight\n" +
                              "2. Kattints MÉG EGYSZER (500ms-en belül) -> Szerkeszthető\n" +
                              "3. Kattints ki -> Read-only",
                        renderWhitespace: true
                    }).addStyleClass("sapUiSmallMarginBottom"),
                    oTable
                ]
            });

            // =============================================
            // TAB 2: VONALKÓD MEGERŐSÍTÉS DEMO
            // =============================================
            var STATE = { IDLE: "IDLE", PENDING: "PENDING", CONFIRMED: "CONFIRMED", ERROR: "ERROR" };
            var barcodeState = STATE.IDLE;
            var lastScannedBarcode = null;

            var oBarcodeInput = new Input({
                placeholder: "Olvasd be a vonalkódot...",
                width: "400px"
            });

            var oStateText = new Text({ text: "Állapot: IDLE" });

            function updateStateDisplay() {
                var msg = "Állapot: " + barcodeState;
                if (lastScannedBarcode) {
                    msg += " | Utolsó vonalkód: " + lastScannedBarcode;
                }
                oStateText.setText(msg);
            }

            function resetBarcodeState() {
                barcodeState = STATE.IDLE;
                lastScannedBarcode = null;
                oBarcodeInput.setValue("");
                var domRef = oBarcodeInput.getDomRef();
                if (domRef) {
                    domRef.style.backgroundColor = "";
                    domRef.style.border = "";
                }
                updateStateDisplay();
            }

            function handleBarcodeScanned(barcode) {
                var domRef = oBarcodeInput.getDomRef();

                if (barcodeState === STATE.IDLE) {
                    barcodeState = STATE.PENDING;
                    lastScannedBarcode = barcode;
                    MessageToast.show("Először beolvasva - olvasd be újra a megerősítéshez!");
                    domRef.style.backgroundColor = "#fff3cd";
                    domRef.style.border = "2px solid #ffc107";

                } else if (barcodeState === STATE.PENDING) {
                    if (barcode === lastScannedBarcode) {
                        barcodeState = STATE.CONFIRMED;
                        MessageToast.show("Megerősítve! Művelet végrehajtva.");
                        domRef.style.backgroundColor = "#d4edda";
                        domRef.style.border = "2px solid #28a745";
                        setTimeout(resetBarcodeState, 2000);
                    } else {
                        barcodeState = STATE.ERROR;
                        MessageToast.show("Hiba! Rossz vonalkód. Olvasd be újra: " + lastScannedBarcode);
                        domRef.style.backgroundColor = "#f8d7da";
                        domRef.style.border = "2px solid #dc3545";
                        setTimeout(function () {
                            barcodeState = STATE.PENDING;
                            domRef.style.backgroundColor = "#fff3cd";
                            domRef.style.border = "2px solid #ffc107";
                            updateStateDisplay();
                        }, 1500);
                    }
                }
                updateStateDisplay();
            }

            oBarcodeInput.attachBrowserEvent("keypress", function (e) {
                if (e.key === "Enter") {
                    var barcode = oBarcodeInput.getValue().trim();
                    if (barcode) {
                        handleBarcodeScanned(barcode);
                    }
                }
            });

            oBarcodeInput.attachBrowserEvent("keydown", function (e) {
                if (e.key === "Escape") {
                    if (barcodeState !== STATE.IDLE) {
                        MessageToast.show("Megerősítés megszakítva.");
                        resetBarcodeState();
                    }
                }
            });

            var oBarcodeTab = new VBox({
                alignItems: "Center",
                items: [
                    new Title({ text: "Vonalkód Kétlépcsős Megerősítés", level: "H3" })
                        .addStyleClass("sapUiSmallMarginTop"),
                    new Text({ text: "1) Olvasd be a vonalkódot (vagy írd be és nyomj ENTER-t)" })
                        .addStyleClass("sapUiTinyMarginBottom"),
                    new Text({ text: "2) Olvasd be ÚJRA ugyanazt a vonalkódot a megerősítéshez" })
                        .addStyleClass("sapUiSmallMarginBottom"),
                    oBarcodeInput,
                    new HBox({
                        items: [
                            new Button({
                                text: "Teszt: 123456",
                                press: function () {
                                    oBarcodeInput.setValue("123456");
                                    handleBarcodeScanned("123456");
                                }
                            }),
                            new Button({
                                text: "Teszt: 789012",
                                press: function () {
                                    oBarcodeInput.setValue("789012");
                                    handleBarcodeScanned("789012");
                                }
                            }),
                            new Button({
                                text: "Reset",
                                type: "Emphasized",
                                press: function () {
                                    resetBarcodeState();
                                    MessageToast.show("Állapot visszaállítva.");
                                }
                            })
                        ]
                    }).addStyleClass("sapUiSmallMarginTop"),
                    oStateText.addStyleClass("sapUiSmallMarginTop")
                ]
            }).addStyleClass("sapUiMediumMargin");

            // =============================================
            // TAB 3: COMPONENT ALAPÚ (MVC)
            // =============================================
            var oComponentTab = new VBox({
                class: "sapUiSmallMargin",
                items: [
                    new MessageStrip({
                        text: "A Component alapú futtatáshoz használd: ?env=local módot és a ui5 serve-öt, " +
                              "majd navigálj a /test/component.html-re.",
                        type: "Warning",
                        showIcon: true
                    }),
                    new Text({
                        text: "A Component.js + manifest.json + MVC struktúra (view/Main.view.xml, controller/Main.controller.js) " +
                              "továbbra is elérhető a projektben, de ez az index.html a standalone demókat szolgálja ki."
                    }).addStyleClass("sapUiSmallMarginTop")
                ]
            });

            // =============================================
            // ICON TAB BAR
            // =============================================
            var oIconTabBar = new IconTabBar({
                expanded: true,
                items: [
                    new IconTabFilter({
                        text: "Dupla-kattintás",
                        icon: "sap-icon://touch",
                        content: [oDoubleClickTab]
                    }),
                    new IconTabFilter({
                        text: "Vonalkód",
                        icon: "sap-icon://bar-code",
                        content: [oBarcodeTab]
                    }),
                    new IconTabFilter({
                        text: "Component (MVC)",
                        icon: "sap-icon://developer-settings",
                        content: [oComponentTab]
                    })
                ]
            });

            // =============================================
            // FŐ OLDAL
            // =============================================
            var oPage = new Page({
                title: "UI5 Double-Click POC",
                subHeader: oToolbar,
                content: [oEnvStrip, oIconTabBar]
            });

            var oApp = new App({ pages: [oPage] });
            oApp.placeAt("content");

            MessageToast.show("App betöltve — " + currentConfig.name);
        });
    };

    // UI5 betöltése a config.js-ből
    window.UI5Bootstrap.load("onAppInit");
</script>
</body>
</html>
